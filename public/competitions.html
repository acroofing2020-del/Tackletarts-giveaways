<!doctype html>
<html>
<head><meta charset="utf-8"><title>Competitions</title></head>
<body>
  <h2>Open Competitions</h2>
  <div id="list"></div>
  <hr>
  <div>
    <label>Quantity (tickets @ £0.25 each):</label>
    <input id="qty" type="range" min="1" max="1000" value="1" oninput="qv.innerText=this.value">
    <b id="qv">1</b>
    <div>Total: £<span id="total">0.25</span></div>
    <button id="buyBtn" disabled>Buy</button>
  </div>

<script>
let currentComp = null;
const qtyEl = document.getElementById('qty');
const totalEl = document.getElementById('total');
qtyEl.addEventListener('input', ()=> {
  totalEl.textContent = (qtyEl.value * 0.25).toFixed(2);
});

async function loadComps(){
  const r = await fetch('/api/competitions');
  const comps = await r.json();
  const list = document.getElementById('list');
  list.innerHTML = '';
  comps.forEach(c=>{
    const d = document.createElement('div');
    d.style.margin='12px 0';
    d.innerHTML = `<b>${c.title}</b> — ${c.description || ''}<br>
      Tickets: ${c.total_tickets} • Instant wins: ${c.instant_win_count}`;
    d.onclick = () => selectComp(c);
    list.appendChild(d);
  });
}
function selectComp(c){
  currentComp = c;
  document.getElementById('buyBtn').disabled = false;
}
document.getElementById('buyBtn').onclick = async () => {
  if(!currentComp) return alert('Pick a competition first');
  const quantity = parseInt(qtyEl.value,10);
  const res = await fetch('/api/checkout',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ competitionId: currentComp.id, quantity })
  });
  const data = await res.json();
  if(data.url) location.href = data.url;
  else alert('Checkout error');
};

loadComps();
</script>
</body>
</html>
